<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lexington PD CFS Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 18px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-start; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    .controls { display: grid; grid-template-columns: 160px 1fr; gap: 10px; align-items: center; }
    label { font-weight: 600; }
    select, input[type="range"] { width: 100%; }
    .tabs { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    .tabbtn { border: 1px solid #bbb; background: #f7f7f7; border-radius: 8px; padding: 8px 10px; cursor: pointer; }
    .tabbtn.active { background: #e8f0ff; border-color: #6b8cff; }
    .imgwrap { margin-top: 14px; }
    img { width: 100%; height: auto; border-radius: 10px; border: 1px solid #eee; }
    .small { color: #555; font-size: 13px; line-height: 1.35; }
    .title { font-size: 18px; font-weight: 700; margin: 0 0 6px 0; }
    .subtitle { margin: 0 0 10px 0; color: #444; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f1f1f1; font-size: 12px; margin-left: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="card">
    <p class="title">Lexington PD — CFS Demand, Proactive Activity, and Response Time</p>
    <p class="subtitle">
      Dropdown + quarter slider swaps pre-rendered maps.
      <span class="pill" id="buildstamp"></span>
    </p>

    <div class="row">
      <div class="card" style="flex: 1 1 520px;">
        <div class="controls">
          <label for="denom">Call type</label>
          <select id="denom"></select>

          <label for="period">Quarter</label>
          <div>
            <input id="period" type="range" min="0" max="0" value="0" step="1"/>
            <div class="small">Selected: <span class="mono" id="periodLabel"></span></div>
          </div>
        </div>

        <div class="tabs">
          <button class="tabbtn active" data-view="hotspot">Hotspots</button>
          <button class="tabbtn" data-view="overlay">Proactive vs Demand</button>
          <button class="tabbtn" data-view="diff">Difference</button>
          <button class="tabbtn" data-view="rt_map">Response Time (Map)</button>
          <button class="tabbtn" data-view="rt_trend">Response Time (Trend)</button>
        </div>

        <p class="small" style="margin-top:10px;">
          <b>Hotspots</b> shows where calls cluster for the selected call type.
          <b>Proactive</b> is a proxy (traffic/property-check with very short dispatch→arrive).
          <b>Difference</b> is proactive density minus demand density (normalized each quarter).
          Response time uses <b>Call→Arrive</b>.
        </p>
      </div>

      <div class="card" style="flex: 2 1 620px;">
        <div class="imgwrap">
          <img id="mainImg" alt="Map output"/>
        </div>
        <p class="small" id="missingNote" style="display:none;">
          This view is missing for the selected call type/quarter (usually because counts were too low).
        </p>
      </div>
    </div>
  </div>

<script>
let manifest = null;
let currentView = "hotspot";

function keyFor(view, denom, period) {
  if (view === "rt_trend") return "rt_trend_systemwide";
  if (view === "rt_map") return `rt_map__${period}`;
  return `${view}__${denom}__${period}`;
}

function setActiveTab(view) {
  currentView = view;
  document.querySelectorAll(".tabbtn").forEach(b => {
    b.classList.toggle("active", b.dataset.view === view);
  });
  render();
}

function render() {
  if (!manifest) return;

  const denom = document.getElementById("denom").value;
  const idx = parseInt(document.getElementById("period").value, 10);
  const period = manifest.periods[idx];

  document.getElementById("periodLabel").textContent = period;

  const k = keyFor(currentView, denom, period);
  const rel = manifest.files[k];

  const img = document.getElementById("mainImg");
  const note = document.getElementById("missingNote");

  if (!rel) {
    img.removeAttribute("src");
    note.style.display = "block";
    return;
  }
  note.style.display = "none";
  img.src = rel;
}

async function init() {
  const res = await fetch("manifest.json");
  manifest = await res.json();

  document.getElementById("buildstamp").textContent = `Built: ${manifest.generated_utc} UTC`;

  const denomSel = document.getElementById("denom");
  manifest.denoms.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    denomSel.appendChild(opt);
  });
  denomSel.value = manifest.denoms.includes("all_calls") ? "all_calls" : manifest.denoms[0];

  const slider = document.getElementById("period");
  slider.min = 0;
  slider.max = (manifest.periods.length - 1).toString();
  slider.value = (manifest.periods.length - 1).toString();

  denomSel.addEventListener("change", render);
  slider.addEventListener("input", render);

  document.querySelectorAll(".tabbtn").forEach(b => {
    b.addEventListener("click", () => setActiveTab(b.dataset.view));
  });

  render();
}

init();
</script>
</body>
</html>
